<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#111111" />
  <title>Knitting Counter</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 18px 40px rgba(0,0,0,0.10);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100svh;
      display: grid;
      place-items: center;
      padding: 18px;
    }
    .app {
      width: min(420px, 92vw);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .topbar {
      padding: 14px 14px 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #fff, #fafafa);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: -0.2px;
    }
    .brand small { color: var(--muted); font-weight: 600; }

    .tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 12px 14px 0;
    }
    .tab {
      border: 1px solid var(--border);
      background: #fff;
      padding: 12px 12px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      transition: transform .05s ease, background .15s ease;
    }
    .tab:active { transform: scale(0.99); }
    .tab.active {
      background: #111;
      color: #fff;
      border-color: #111;
    }
    .tab .label { font-weight: 800; }
    .tab .value { font-weight: 900; font-variant-numeric: tabular-nums; }

    .panel {
      padding: 16px 14px 14px;
      display: grid;
      gap: 12px;
    }
    .countBox {
      background: #0f172a;
      color: #fff;
      border-radius: 16px;
      padding: 18px 16px;
      display: grid;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }
    .countBox::after{
      content:"";
      position:absolute; inset:-60px -60px auto auto;
      width: 180px; height: 180px;
      background: radial-gradient(circle, rgba(255,255,255,0.16), rgba(255,255,255,0));
      transform: rotate(15deg);
    }
    .countTitle {
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      z-index: 1;
    }
    .countTitle .left { display:flex; align-items:center; gap:10px; }
    .badge {
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      background: rgba(255,255,255,0.10);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      z-index: 1;
      user-select: none;
    }
    .bigNum {
      font-size: 56px;
      font-weight: 950;
      letter-spacing: -1px;
      z-index: 1;
      font-variant-numeric: tabular-nums;
      line-height: 1.05;
    }
    .sub {
      color: rgba(255,255,255,0.78);
      font-size: 13px;
      z-index: 1;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    button {
      border: none;
      border-radius: 16px;
      padding: 14px 14px;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      user-select: none;
      transition: transform .05s ease, filter .15s ease;
    }
    button:active { transform: scale(0.99); }
    button.primary {
      background: #22c55e;
      color: #052e16;
    }
    button.secondary {
      background: #eef2ff;
      color: #1f2937;
    }
    button.danger {
      background: #fee2e2;
      color: #7f1d1d;
    }
    button.ghost {
      background: #f3f4f6;
      color: #111;
    }

    .settings {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      display: grid;
      gap: 10px;
      background: #fff;
    }
    .row {
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .row .hint { color: var(--muted); font-size: 13px; }
    .pill {
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .toggle {
      width: 52px; height: 30px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f3f4f6;
      position: relative;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .toggle i {
      position:absolute;
      top: 3px; left: 3px;
      width: 24px; height: 24px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid var(--border);
      transition: left .18s ease, background .18s ease;
    }
    .toggle.on { background: #111; border-color:#111; }
    .toggle.on i { left: 25px; border-color:#111; }

    input[type="number"], select {
      width: 110px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    .footnote {
      padding: 0 14px 16px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }
    .tiny {
      font-size: 12px;
      color: var(--muted);
    }
    .divider { height: 1px; background: var(--border); margin: 2px 0; }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">ğŸ§¶ Knitting Counter <small>ë‹¨ìˆ˜/ì½”ìˆ˜</small></div>
      <div class="pill">
        <span class="tiny" id="wakeLabel">í™”ë©´ìœ ì§€: -</span>
        <div class="toggle" id="wakeToggle" title="í™”ë©´ êº¼ì§ ë°©ì§€(ì§€ì› ê¸°ê¸°)">
          <i></i>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tab-rows" onclick="setActive('rows')">
        <span class="label">ë‹¨ìˆ˜</span>
        <span class="value" id="mini-rows">0</span>
      </div>
      <div class="tab" id="tab-stitches" onclick="setActive('stitches')">
        <span class="label">ì½”ìˆ˜</span>
        <span class="value" id="mini-stitches">0</span>
      </div>
    </div>

    <div class="panel">
      <div class="countBox">
        <div class="countTitle">
          <div class="left">
            <div class="badge" id="activeBadge">í˜„ì¬: ë‹¨ìˆ˜</div>
            <div class="badge" id="stepBadge">+1ì”©</div>
          </div>
          <div class="badge" id="notifyBadge">10/20 ì•Œë¦¼</div>
        </div>
        <div class="bigNum" id="bigCount">0</div>
        <div class="sub">+ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦ê°€ Â· Undoë¡œ ë˜ëŒë¦¬ê¸° ê°€ëŠ¥</div>
      </div>

      <div class="grid2">
        <button class="primary" onclick="add()">+ ì¦ê°€</button>
        <button class="ghost" onclick="undo()">â†© Undo</button>
      </div>

      <div class="grid2">
        <button class="secondary" onclick="subtract()">âˆ’ ê°ì†Œ</button>
        <button class="danger" onclick="resetCount()">ë¦¬ì…‹(0)</button>
      </div>

      <div class="settings">
        <div class="row">
          <div>
            <div style="font-weight:900;">ë‹¨ìˆ˜/ì½”ìˆ˜ ì„ íƒ</div>
            <div class="hint">íƒ­(ë‹¨ìˆ˜/ì½”ìˆ˜)ì„ ëˆŒëŸ¬ ë°”ê¿”ì¤˜</div>
          </div>
          <select id="activeSelect" onchange="setActive(this.value)">
            <option value="rows">ë‹¨ìˆ˜</option>
            <option value="stitches">ì½”ìˆ˜</option>
          </select>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <div style="font-weight:900;">ì¦ê°€ ë‹¨ìœ„(ë‹¨ìˆ˜ë³€ê²½)</div>
            <div class="hint">+ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ëª‡ì”© ì˜¬ë¦´ì§€</div>
          </div>
          <input id="stepInput" type="number" min="1" step="1" value="1" />
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <div style="font-weight:900;">í´ë¦­ ì§„ë™</div>
            <div class="hint">íœ´ëŒ€í°ì—ì„œë§Œ ë™ì‘(ì§€ì› ì‹œ)</div>
          </div>
          <div class="toggle" id="vibeToggle" title="ì§„ë™ On/Off"><i></i></div>
        </div>

        <div class="row">
          <div>
            <div style="font-weight:900;">í´ë¦­ ì†Œë¦¬</div>
            <div class="hint">ì¡°ìš©íˆ ì“°ê³  ì‹¶ìœ¼ë©´ Off</div>
          </div>
          <div class="toggle" id="soundToggle" title="ì†Œë¦¬ On/Off"><i></i></div>
        </div>

        <div class="row">
          <div>
            <div style="font-weight:900;">10/20 ì•Œë¦¼</div>
            <div class="hint">10Â·20ë§ˆë‹¤ ë” ê°•í•˜ê²Œ</div>
          </div>
          <div class="toggle" id="notifyToggle" title="ì•Œë¦¼ On/Off"><i></i></div>
        </div>

        <div class="tiny">
          ğŸ’¾ ìˆ«ì/ì„¤ì •ì€ ìë™ ì €ì¥ë¼ì„œ ì•± ê»ë‹¤ ì¼œë„ ìœ ì§€ë¼!
        </div>
      </div>
    </div>

    <div class="footnote">
      â€¢ íŒ: ì†Œë¦¬/ì§„ë™ì€ ë¸Œë¼ìš°ì € ì •ì±…ìƒ <b>ì²˜ìŒ í•œ ë²ˆì€ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼</b> í™œì„±í™”ë˜ëŠ” ê²½ìš°ê°€ ìˆì–´.<br/>
      â€¢ í™”ë©´ìœ ì§€(êº¼ì§ ë°©ì§€)ëŠ” ê¸°ê¸°/ë¸Œë¼ìš°ì € ì§€ì›ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆì–´.
    </div>
  </div>

  <script>
    // ---------- State ----------
    const STORAGE_KEY = "knittingCounter_v2";
    const state = {
      active: "rows",                 // 'rows' | 'stitches'
      counts: { rows: 0, stitches: 0 },
      step: 1,
      history: { rows: [], stitches: [] }, // undo stacks
      settings: {
        vibration: true,
        sound: false,
        notify: true,
        wakeLock: false
      }
    };

    // ---------- UI refs ----------
    const $ = (id) => document.getElementById(id);

    const tabRows = $("tab-rows");
    const tabStitches = $("tab-stitches");
    const miniRows = $("mini-rows");
    const miniStitches = $("mini-stitches");
    const bigCount = $("bigCount");
    const activeBadge = $("activeBadge");
    const stepBadge = $("stepBadge");
    const notifyBadge = $("notifyBadge");

    const activeSelect = $("activeSelect");
    const stepInput = $("stepInput");

    const vibeToggle = $("vibeToggle");
    const soundToggle = $("soundToggle");
    const notifyToggle = $("notifyToggle");
    const wakeToggle = $("wakeToggle");
    const wakeLabel = $("wakeLabel");

    // ---------- Persist ----------
    function load() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const saved = JSON.parse(raw);

        if (saved && typeof saved === "object") {
          if (saved.active) state.active = saved.active;
          if (saved.counts) state.counts = { ...state.counts, ...saved.counts };
          if (saved.step) state.step = Number(saved.step) || 1;
          if (saved.history) state.history = {
            rows: Array.isArray(saved.history.rows) ? saved.history.rows : [],
            stitches: Array.isArray(saved.history.stitches) ? saved.history.stitches : []
          };
          if (saved.settings) state.settings = { ...state.settings, ...saved.settings };
        }
      } catch (e) {
        console.warn("load failed", e);
      }
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // ---------- Sound (WebAudio beep) ----------
    let audioCtx = null;
    function beep(strength = "soft") {
      if (!state.settings.sound) return;

      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const ctx = audioCtx;

        const o = ctx.createOscillator();
        const g = ctx.createGain();

        let freq = 520;
        let dur = 0.06;
        let gain = 0.06;

        if (strength === "mid") { freq = 660; dur = 0.08; gain = 0.08; }
        if (strength === "strong") { freq = 880; dur = 0.12; gain = 0.10; }

        o.type = "sine";
        o.frequency.value = freq;
        g.gain.value = gain;

        o.connect(g);
        g.connect(ctx.destination);

        const now = ctx.currentTime;
        o.start(now);
        o.stop(now + dur);
      } catch (e) {
        // no-op
      }
    }

    // ---------- Vibration ----------
    function vibrate(pattern) {
      if (!state.settings.vibration) return;
      if (navigator.vibrate) navigator.vibrate(pattern);
    }

    // ---------- Wake Lock ----------
    let wakeLock = null;
    async function setWakeLock(on) {
      state.settings.wakeLock = !!on;
      updateToggles();
      save();

      if (!("wakeLock" in navigator) || !navigator.wakeLock) {
        wakeLabel.textContent = "í™”ë©´ìœ ì§€: ì§€ì›X";
        return;
      }

      if (!on) {
        try {
          if (wakeLock) await wakeLock.release();
        } catch (e) {}
        wakeLock = null;
        wakeLabel.textContent = "í™”ë©´ìœ ì§€: Off";
        return;
      }

      try {
        wakeLock = await navigator.wakeLock.request("screen");
        wakeLabel.textContent = "í™”ë©´ìœ ì§€: On";
        wakeLock.addEventListener("release", () => {
          // release can happen automatically
          wakeLabel.textContent = "í™”ë©´ìœ ì§€: Off";
          state.settings.wakeLock = false;
          updateToggles();
          save();
        });
      } catch (e) {
        wakeLabel.textContent = "í™”ë©´ìœ ì§€: ì‹¤íŒ¨";
        state.settings.wakeLock = false;
        updateToggles();
        save();
      }
    }

    document.addEventListener("visibilitychange", () => {
      // keep alive after tab returns (if user wants)
      if (document.visibilityState === "visible" && state.settings.wakeLock) {
        setWakeLock(true);
      }
    });

    // ---------- Helpers ----------
    function clampNonNegative(n) {
      n = Number(n) || 0;
      return Math.max(0, n);
    }

    function activeName() {
      return state.active === "rows" ? "ë‹¨ìˆ˜" : "ì½”ìˆ˜";
    }

    function currentCount() {
      return state.counts[state.active];
    }

    function pushHistory(prevValue) {
      const stack = state.history[state.active];
      stack.push(prevValue);
      // ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šê²Œ ì œí•œ(ì˜ˆ: 200ë‹¨ê³„)
      if (stack.length > 200) stack.shift();
    }

    // ---------- Core actions ----------
    function add() {
      const step = clampNonNegative(stepInput.value) || 1;
      state.step = step;

      const prev = currentCount();
      pushHistory(prev);

      state.counts[state.active] = prev + step;

      clickFeedback();
      milestoneFeedback();
      render();
      save();
    }

    function subtract() {
      const step = clampNonNegative(stepInput.value) || 1;
      state.step = step;

      const prev = currentCount();
      pushHistory(prev);

      state.counts[state.active] = Math.max(0, prev - step);

      clickFeedback();
      render();
      save();
    }

    function undo() {
      const stack = state.history[state.active];
      if (!stack.length) {
        // ë¹ˆ Undoë©´ ì‚´ì§ ì§„ë™ë§Œ
        vibrate([20]);
        beep("soft");
        return;
      }
      const prev = stack.pop();
      state.counts[state.active] = clampNonNegative(prev);

      // Undo í”¼ë“œë°±
      vibrate([25]);
      beep("mid");

      render();
      save();
    }

    function resetCount() {
      const prev = currentCount();
      pushHistory(prev);

      state.counts[state.active] = 0;
      // ë¦¬ì…‹ì€ ê°•í•œ í”¼ë“œë°±
      vibrate([40, 40, 40]);
      beep("strong");

      render();
      save();
    }

    function clickFeedback() {
      vibrate([15]);
      beep("soft");
    }

    function milestoneFeedback() {
      if (!state.settings.notify) return;

      const n = currentCount();
      // 20 ë°°ìˆ˜: ë” ê°•í•˜ê²Œ / 10 ë°°ìˆ˜: ì¤‘ê°„
      if (n > 0 && n % 20 === 0) {
        vibrate([80, 40, 80, 40, 120]);
        beep("strong");
      } else if (n > 0 && n % 10 === 0) {
        vibrate([50, 30, 70]);
        beep("mid");
      }
    }

    // ---------- UI ----------
    function setActive(which) {
      state.active = which;
      activeSelect.value = which;
      render();
      save();
    }

    function setToggle(el, on) {
      el.classList.toggle("on", !!on);
    }

    function updateToggles() {
      setToggle(vibeToggle, state.settings.vibration);
      setToggle(soundToggle, state.settings.sound);
      setToggle(notifyToggle, state.settings.notify);
      setToggle(wakeToggle, state.settings.wakeLock);

      if (!("wakeLock" in navigator) || !navigator.wakeLock) {
        wakeLabel.textContent = "í™”ë©´ìœ ì§€: ì§€ì›X";
      } else {
        wakeLabel.textContent = state.settings.wakeLock ? "í™”ë©´ìœ ì§€: On" : "í™”ë©´ìœ ì§€: Off";
      }

      notifyBadge.textContent = state.settings.notify ? "10/20 ì•Œë¦¼" : "ì•Œë¦¼ Off";
    }

    function render() {
      miniRows.textContent = state.counts.rows;
      miniStitches.textContent = state.counts.stitches;

      tabRows.classList.toggle("active", state.active === "rows");
      tabStitches.classList.toggle("active", state.active === "stitches");

      activeBadge.textContent = `í˜„ì¬: ${activeName()}`;
      bigCount.textContent = currentCount();

      const step = clampNonNegative(stepInput.value) || state.step || 1;
      stepBadge.textContent = `+${step}ì”©`;

      updateToggles();
    }

    // ---------- Toggle handlers ----------
    vibeToggle.addEventListener("click", () => {
      state.settings.vibration = !state.settings.vibration;
      if (state.settings.vibration) vibrate([15]);
      save();
      render();
    });

    soundToggle.addEventListener("click", async () => {
      state.settings.sound = !state.settings.sound;

      // iOS/ë¸Œë¼ìš°ì € ì •ì±…: ì‚¬ìš©ì ì œìŠ¤ì²˜ë¡œ audioCtx resume í•„ìš”í•  ìˆ˜ ìˆìŒ
      try {
        if (state.settings.sound) {
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          await audioCtx.resume?.();
          beep("mid");
        }
      } catch (e) {}

      save();
      render();
    });

    notifyToggle.addEventListener("click", () => {
      state.settings.notify = !state.settings.notify;
      if (state.settings.notify) { vibrate([25]); beep("mid"); }
      save();
      render();
    });

    wakeToggle.addEventListener("click", () => {
      setWakeLock(!state.settings.wakeLock);
    });

    stepInput.addEventListener("change", () => {
      const step = clampNonNegative(stepInput.value) || 1;
      stepInput.value = step;
      state.step = step;
      save();
      render();
    });

    // ---------- Init ----------
    load();

    // restore UI values
    activeSelect.value = state.active;
    stepInput.value = state.step || 1;

    render();

    // If user previously enabled wakelock, try again
    if (state.settings.wakeLock) setWakeLock(true);

    // expose for inline onclick (already used)
    window.setActive = setActive;
    window.add = add;
    window.undo = undo;
    window.resetCount = resetCount;
    window.subtract = subtract;
  </script>
</body>
</html>
